<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <title>The Chowder Within</title>
    <style>
        /* Add your existing CSS styles here */
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
</head>

<body>
    <div class="sidebar">
        <button id="loginRegisterBtn" class="icon-btn" title="Login/Register"><i class="fas fa-sign-in-alt"></i></button>
        <button id="customizeBtn" class="icon-btn" title="Customize Profile"><i class="fas fa-cog"></i></button>
    </div>

    <div class="main-content">
        <div class="header">
            <h2>The Chowder Within</h2>
        </div>

        <div class="posting-section">
            <div class="file-upload-container">
                <textarea id="postContent" placeholder="Share something... (Include image/video URL or upload)" rows="2"></textarea>
                <button id="postBtn" title="Post"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="postsContainer"></div>
        
        <!-- Profile Modal -->
        <div id="customizeModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeProfile">×</span>
                <h2>Customize Profile</h2>
                <input type="text" id="displayName" placeholder="Display Name">
                <input type="url" id="avatarUrl" placeholder="Avatar URL">
                <button id="saveProfileBtn">Save</button>
            </div>
        </div>

        <!-- Authentication Modals -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeAuth">×</span>
                <h2 id="authTitle">Login</h2>
                <input type="email" id="authEmail" placeholder="Email" required>
                <input type="password" id="authPassword" placeholder="Password" required>
                <button id="loginBtn">Login</button>
                <button id="registerBtn">Register</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // User Authentication
        document.getElementById('loginRegisterBtn').onclick = function () {
            document.getElementById('authModal').style.display = 'block'; // Show authentication modal
        };

        document.getElementById('closeAuth').onclick = function () {
            document.getElementById('authModal').style.display = 'none'; // Hide modal
        };

        document.getElementById('loginBtn').onclick = function () {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    alert('Logged in successfully!');
                    document.getElementById('authModal').style.display = 'none';
                })
                .catch((error) => {
                    alert(error.message);
                });
        };

        document.getElementById('registerBtn').onclick = function () {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    alert('Registered successfully!');
                    document.getElementById('authModal').style.display = 'none';
                })
                .catch((error) => {
                    alert(error.message);
                });
        };

        // Posting Functionality with Firestore
        document.getElementById('postBtn').addEventListener('click', function () {
            const content = document.getElementById('postContent').value.trim();
            const postDiv = document.createElement('div');
            postDiv.className = 'post';

            if (content) {
                let mediaContent = '';
                const urlRegex = /(https?:\/\/[^\s]+)/g; // Regex to match URLs
                const urls = content.match(urlRegex);

                if (urls) {
                    urls.forEach(url => {
                        if (url.match(/\.(jpeg|jpg|gif|png|svg)$/)) {
                            mediaContent += `<img src="${url}" alt="Image Preview">`;
                        } else if (url.match(/(youtube\.com|youtu\.be)/)) {
                            const videoId = url.includes('embed/') ? url.split('/embed/')[1] : url.split('v=')[1].split('&')[0] || url.split('/').pop();
                            mediaContent += `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                        } else if (url.match(/tiktok\.com/)) {
                            const videoId = url.split('/').pop().split('?')[0];
                            mediaContent += `<iframe src="https://www.tiktok.com/embed/${videoId}" width="100%" height="500" frameborder="0" allow="fullscreen"></iframe>`;
                        } else if (url.match(/twitter\.com/)) {
                            const tweetId = url.split('/status/')[1].split('?')[0];
                            mediaContent += `<blockquote class="twitter-tweet"><a href="${url}"></a></blockquote>`;
                        } else if (url.match(/instagram\.com/)) {
                            const postId = url.split('/p/')[1].split('/')[0];
                            mediaContent += `<blockquote class="instagram-media"><a href="${url}"></a></blockquote>`;
                        } else if (url.match(/\.(mp4|webm|ogg)$/)) {
                            mediaContent += `<video controls><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video>`;
                        }
                    });
                }

                postDiv.innerHTML = `
                    <p>${content}</p>
                    ${mediaContent}
                `;
                document.getElementById('postsContainer').appendChild(postDiv);
                document.getElementById('postContent').value = ''; // Clear textarea
                
                // Save post to Firestore
                firestore.collection('posts').add({
                    content: content,
                    media: urls || [],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                alert('Please enter some content to post.');
            }
        });

        // Load posts from Firestore
        firestore.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
            const postsContainer = document.getElementById('postsContainer');
            postsContainer.innerHTML = ''; // Clear existing posts
            snapshot.forEach(doc => {
                const data = doc.data();
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                postDiv.innerHTML = `
                    <p>${data.content}</p>
                    ${data.media.map(url => `<img src="${url}" alt="Image Preview">`).join('')}
                `;
                postsContainer.appendChild(postDiv);
            });
        });

        // Profile customization
        document.getElementById('customizeBtn').onclick = function () {
            document.getElementById('customizeModal').style.display = 'block'; // Show profile customization modal
        };

        document.getElementById('closeProfile').onclick = function () {
            document.getElementById('customizeModal').style.display = 'none'; // Hide modal
        };

        document.getElementById('saveProfileBtn').onclick = function () {
            const displayName = document.getElementById('displayName').value.trim();
            const avatarUrl = document.getElementById('avatarUrl').value.trim();
            const user = firebase.auth().currentUser;
            if (user) {
                firestore.collection('users').doc(user.uid).set({
                    displayName: displayName,
                    avatarUrl: avatarUrl
                }).then(() => {
                    alert('Profile updated!');
                    document.getElementById('customizeModal').style.display = 'none'; // Hide modal
                }).catch(error => {
                    alert(error.message);
                });
            }
        };
    </script>
</body>

</html>
